steps:
  # Download artifacts for web app and Bicep/ARM
  - download: current
    displayName: App Download
    artifact: dropApp
  - download: current
    displayName: ARM Template Download
    artifact: dropARM

  - task: replacetokens@3
    displayName: 'Replace Tokens with Variables'
    inputs:
      targetFiles: '$(Pipeline.Workspace)/dropARM/Tailspin.SpaceGame.Bicep/*.json'
      encoding: 'auto'
      writeBOM: true
      escapeType: 'none'
      actionOnMissing: 'fail'
      keepToken: false
      tokenPrefix: '__'
      tokenSuffix: '__'
      useLegacyPattern: false
      enableTelemetry: true

  - task: RunARMTTKTests@1
    displayName: 'Run Azure Resource Manager Template Toolkit'
    inputs:
      templatelocation: '$(Pipeline.Workspace)/dropARM/Tailspin.SpaceGame.Bicep/*.json'
      resultLocation: '$(Pipeline.Workspace)/dropARM/'

  - task: PublishTestResults@2
    displayName: 'Publish Azure Resource Manager Template Toolkit results'
    inputs:
      testResultsFormat: 'NUnit'
      testResultsFiles: '$(Pipeline.Workspace)\dropARM\*-armttk.xml'
      testRunTitle: 'ARM Template Toolkit Tests (arm-ttk)'
    condition: always()
    
  - task: AzureResourceManagerTemplateDeployment@3
    displayName: 'Apply ARM Template'
    inputs:                
      deploymentScope: 'Resource Group'
      azureResourceManagerConnection: $(serviceConnection)
      subscriptionId: $(subscriptionID)
      action: 'Create Or Update Resource Group'
      resourceGroupName: '$(appresourcegroup)'
      location: '$(region)'
      templateLocation: 'Linked artifact'
      csmFile: '$(Pipeline.Workspace)/dropARM/Tailspin.SpaceGame.Bicep/*.json'
      deploymentMode: 'Incremental'
    condition: succeeded())   

  - task: AzureWebApp@1
    displayName: 'Azure App Service Deploy: website'
    inputs:
      azureSubscription: '$(serviceConnection)'
      appName: '$(appservicename)'
      package: '$(Pipeline.Workspace)/dropApp/$(buildConfiguration)/*.zip'
    condition: succeeded()

  - task: GitHubComment@0
    displayName: 'Add PR comment with site url'  
    inputs:
      gitHubConnection: 'MarcusFelling'
      repositoryName: '$(Build.Repository.Name)'
      comment: 'The new app is ready for testing: $(SITE_URL)'
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'), eq(variables['System.StageName'], 'Dev'))     